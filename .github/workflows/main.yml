name: Main Pipeline

on: [push]

jobs:
  slack_build_started:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Slack Notification
        continue-on-error: true
        uses: rtCamp/action-slack-notify@master
        env:
          SLACK_COLOR: "#304ffe"
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_USERNAME: GitHub Actions
          SLACK_ICON: https://raw.githubusercontent.com/github/explore/2c7e603b797535e5ad8b4beb575ab3b7354666e1/topics/actions/actions.png
          SLACK_TITLE: "${{ GITHUB_SHA }} Build started ðŸš€"
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: subosito/flutter-action@v1
      - name: Install dependencies
        run: flutter pub get
      - name: Run analyzer
        run: flutter analyze
      - name: Run tests
        run: flutter test
      - name: Slack Failure Notification
        if: failure()
        uses: rtCamp/action-slack-notify@master
        continue-on-error: true
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_USERNAME: GitHub Actions
          SLACK_COLOR: "#f50057"
          SLACK_ICON: https://raw.githubusercontent.com/github/explore/2c7e603b797535e5ad8b4beb575ab3b7354666e1/topics/actions/actions.png
          SLACK_TITLE: "${{GITHUB_SHA}} Analysis/Tests failed ðŸ¤¯"
          SLACK_MESSAGE: "$ flutter analyze && flutter test"

  build_android:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-java@v1
        with:
          java-version: "12.x"
      - uses: subosito/flutter-action@v1
      - name: Install dependencies
        run: flutter pub get
      - name: Build app bundle
        run: flutter build appbundle --flavor dev
      - name: Upload bundle
        uses: actions/upload-artifact@v1
        with:
          name: android-archive
          path: build/app/outputs/bundle/devRelease/app-dev-release.aab
      - name: Slack Failure Notification
        if: failure()
        uses: rtCamp/action-slack-notify@master
        continue-on-error: true
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_USERNAME: GitHub Actions
          SLACK_COLOR: "#f50057"
          SLACK_ICON: https://raw.githubusercontent.com/github/explore/2c7e603b797535e5ad8b4beb575ab3b7354666e1/topics/actions/actions.png
          SLACK_TITLE: "${{ GITHUB_SHA }} Android build failed ðŸ¤¯"
          SLACK_MESSAGE: "$ flutter build appbundle --flavor dev"

  build_ios:
    needs: test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v1
      - uses: subosito/flutter-action@v1
      - name: Install dependencies
        run: flutter pub get
      - name: Build app archive
        run: flutter build ios --no-codesign --flavor dev
      - name: Upload bundle
        uses: actions/upload-artifact@v1
        with:
          name: ios-archive
          path: build/ios/iphoneos/Runner.app
      - name: Slack Failure Notification
        if: failure()
        uses: rtCamp/action-slack-notify@master
        continue-on-error: true
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_USERNAME: GitHub Actions
          SLACK_COLOR: "#f50057"
          SLACK_ICON: https://raw.githubusercontent.com/github/explore/2c7e603b797535e5ad8b4beb575ab3b7354666e1/topics/actions/actions.png
          SLACK_TITLE: "${{ GITHUB_SHA }} iOS build failed ðŸ¤¯"
          SLACK_MESSAGE: "$ flutter build ios --no-codesign --flavor dev"

  slack_build_success:
    needs: [test, build_android, build_ios]
    runs-on: ubuntu-latest
    steps:
      - name: Slack Success Notification
        uses: rtCamp/action-slack-notify@master
        continue-on-error: true
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_USERNAME: GitHub Actions
          SLACK_ICON: https://raw.githubusercontent.com/github/explore/2c7e603b797535e5ad8b4beb575ab3b7354666e1/topics/actions/actions.png
          SLACK_TITLE: "${{ GITHUB_SHA }} Build success ðŸŽ‰"
