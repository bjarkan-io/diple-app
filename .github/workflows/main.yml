name: Main Pipeline

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: subosito/flutter-action@v1
      - name: Install dependencies
        run: flutter pub get
      - name: Run analyzer
        run: flutter analyze
      - name: Run tests
        run: flutter test

  build_android:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-java@v1
        with:
          java-version: "12.x"
      - uses: subosito/flutter-action@v1
      - name: Install dependencies
        run: flutter pub get
      - name: Build app bundle
        run: flutter build appbundle --flavor dev
      - name: Upload bundle
        uses: actions/upload-artifact@v1
        with:
          name: android-archive
          path: build/app/outputs/bundle/devRelease/app-dev-release.aab

  build_ios:
    needs: test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v1
      - uses: subosito/flutter-action@v1
      - name: Install dependencies
        run: flutter pub get
      - name: Build app archive
        run: flutter build ios --no-codesign --flavor dev
      - name: Upload bundle
        uses: actions/upload-artifact@v1
        with:
          name: ios-archive
          path: build/ios/iphoneos/Runner.app

  slack_build_success:
    needs: [test, build_android, build_ios]
    runs-on: ubuntu-latest
    steps:
      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: bjarkan-io/diple-app
          event-type: build-success
